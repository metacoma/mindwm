---
classes:
  - common
  - mindwm
  - vim
  - tmuxinator
  - bash.kapitan
  - tmuxinator
  - tmuxinator.kapitan
  - logstash
  - kapitan.bash.compile-fetch
  - kafka
  - vector
  - vector.tmux-bytestream-kafka
#  - vector.tmux-kafka
#  - vector.console-output
  - vector.config
  - vector.helm

parameters:

  target_name: vector


  bash:
    functions:
      kapitan_compile: |
        cd ${kapitan_root}
        ./kapitan.sh compile --fetch -t ${target_name}
      # https://vector.dev/docs/setup/installation/package-managers/nix/
      vector_upgrade: |
        local values_file=\${1:-${compiled_dir}/vector_helm/values.yaml}
        (
          cd ${kapitan_root}/files/helm-charts/vector
          helm upgrade vector --install -n ${vector_k8s_ns} . -f ${compiled_dir}/vector_helm/values.yaml $*
        )
      vector_values: |
        (
          cd ${kapitan_root}/files/helm-charts/vector
          vim -R values.yaml
        )
      vector_logs: |
        (
          kubectl -n ${vector_k8s_ns} logs -f vector-0
        )

  vector_aggregator_port: 31399

  vector:
    aggregator:
      image:
        repository: ${vector_image:repo}
        tag: ${vector_image:tag}
      serviceHeadless:
        enabled: false
      service:
        enabled: True
        type: "NodePort"
        ports:
          - name: aggregator
            protocol: TCP
            port: ${vector_aggregator_port}
            targetPort: ${vector_aggregator_port}
            nodePort: ${vector_aggregator_port}
      customConfig:
#
#
#                       ___  ___  _   _ _ __ ___ ___  ___
#                      / __|/ _ \| | | | '__/ __/ _ \/ __|
#                      \__ \ (_) | |_| | | | (_|  __/\__ \
#                      |___/\___/ \__,_|_|  \___\___||___/
#
#

        sources:
          tmux-pane-bytestream:
            type: socket
            mode: tcp
            address: 0.0.0.0:${vector_aggregator_port}

#              _                        __
#             | |                      / _|
#             | |_ _ __ __ _ _ __  ___| |_ ___  _ __ _ __ ___  ___
#             | __| '__/ _` | '_ \/ __|  _/ _ \| '__| '_ ` _ \/ __|
#             | |_| | | (_| | | | \__ \ || (_) | |  | | | | | \__ \
#              \__|_|  \__,_|_| |_|___/_| \___/|_|  |_| |_| |_|___/
#
#

        transforms:
          tmux-stream-split-line:
            type: "lua"
            version: "2"
            inputs:
              - tmux-pane-bytestream
            hooks:
              process: process
            source: |
              function process(event, emit)
                emit(event)
              end

#                                  _       _
#                                 (_)     | |
#                              ___ _ _ __ | | _____
#                             / __| | '_ \| |/ / __|
#                             \__ \ | | | |   <\__ \
#                             |___/_|_| |_|_|\_\___/
#
#

        sinks:
          console:
            type: console
            inputs:
              - tmux-pane-bytestream
            encoding:
              codec: json
          kafka-tmux-pane-bytestream:
            type: kafka
            inputs:
              - tmux-pane-bytestream
            bootstrap_servers: "${kafka_cluster_name}-kafka-external-bootstrap.${kafka_k8s_namespace}:${kafka_port}"
            topic: "${kafka_topic_tmux_bytestream}"
            compression: "none"
            encoding:
              codec: json
          kafka-tmux-pane-linestream:
            type: kafka
            inputs:
              -  tmux-pane-bytestream
            bootstrap_servers: "${kafka_cluster_name}-kafka-external-bootstrap.${kafka_k8s_namespace}:${kafka_port}"
            topic: "${kafka_topic_tmux_linestream}"
            compression: "none"
            encoding:
              codec: json
#          kafka-tmux-pane-io-context:
#            type: kafka
#            inputs:
#              - tmux-pane-io-context
#            bootstrap_servers: "${kafka_cluster_name}-kafka-external-bootstrap.${kafka_k8s_namespace}:${kafka_port}"
#            topic: "${kafka_topic_tmux_io_context}"
#            compression: "none"
#            encoding:
#              codec: json

  tmuxinator:
    windows:
      helm:
        panes:
          - cd ${kapitan_root}/files/helm-charts/vector
          - cd ${kapitan_root}/files/helm-charts/vector
      shell:
        panes:
          # tmux list-windows -a -F '#{window_id} #{pane_id}'
          -
            - tmux pipe-pane -IO "perl ${compiled_dir}/pipe-pane2hexstream.pl | VECTOR_UPSTREAM=`minikube ip`:${vector_aggregator_port} TMUX_PANE_ID='$TMUX_PANE' vector -q --config ${compiled_dir}/vector/tmux-bytestream.yaml"
          -
            -

